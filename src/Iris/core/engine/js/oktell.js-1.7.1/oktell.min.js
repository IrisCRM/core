var swfobject=function(){function a(){if(!R){try{var a=K.getElementsByTagName("body")[0].appendChild(q("span"));a.parentNode.removeChild(a)}catch(b){return}R=!0;for(var c=N.length,d=0;c>d;d++)N[d]()}}function b(a){R?a():N[N.length]=a}function c(a){if(typeof J.addEventListener!=C)J.addEventListener("load",a,!1);else if(typeof K.addEventListener!=C)K.addEventListener("load",a,!1);else if(typeof J.attachEvent!=C)r(J,"onload",a);else if("function"==typeof J.onload){var b=J.onload;J.onload=function(){b(),a()}}else J.onload=a}function d(){M?e():f()}function e(){var a=K.getElementsByTagName("body")[0],b=q(D);b.setAttribute("type",G);var c=a.appendChild(b);if(c){var d=0;!function(){if(typeof c.GetVariable!=C){var e=c.GetVariable("$version");e&&(e=e.split(" ")[1].split(","),U.pv=[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10)])}else if(10>d)return d++,setTimeout(arguments.callee,10),void 0;a.removeChild(b),c=null,f()}()}else f()}function f(){var a=O.length;if(a>0)for(var b=0;a>b;b++){var c=O[b].id,d=O[b].callbackFn,e={success:!1,id:c};if(U.pv[0]>0){var f=p(c);if(f)if(!s(O[b].swfVersion)||U.wk&&U.wk<312)if(O[b].expressInstall&&h()){var k={};k.data=O[b].expressInstall,k.width=f.getAttribute("width")||"0",k.height=f.getAttribute("height")||"0",f.getAttribute("class")&&(k.styleclass=f.getAttribute("class")),f.getAttribute("align")&&(k.align=f.getAttribute("align"));for(var l={},m=f.getElementsByTagName("param"),n=m.length,o=0;n>o;o++)"movie"!=m[o].getAttribute("name").toLowerCase()&&(l[m[o].getAttribute("name")]=m[o].getAttribute("value"));i(k,l,c,d)}else j(f),d&&d(e);else u(c,!0),d&&(e.success=!0,e.ref=g(c),d(e))}else if(u(c,!0),d){var q=g(c);q&&typeof q.SetVariable!=C&&(e.success=!0,e.ref=q),d(e)}}}function g(a){var b=null,c=p(a);if(c&&"OBJECT"==c.nodeName)if(typeof c.SetVariable!=C)b=c;else{var d=c.getElementsByTagName(D)[0];d&&(b=d)}return b}function h(){return!S&&s("6.0.65")&&(U.win||U.mac)&&!(U.wk&&U.wk<312)}function i(a,b,c,d){S=!0,y=d||null,z={success:!1,id:c};var e=p(c);if(e){"OBJECT"==e.nodeName?(w=k(e),x=null):(w=e,x=c),a.id=H,(typeof a.width==C||!/%$/.test(a.width)&&parseInt(a.width,10)<310)&&(a.width="310"),(typeof a.height==C||!/%$/.test(a.height)&&parseInt(a.height,10)<137)&&(a.height="137"),K.title=K.title.slice(0,47)+" - Flash Player Installation";var f=U.ie&&U.win?"ActiveX":"PlugIn",g="MMredirectURL="+J.location.toString().replace(/&/g,"%26")+"&MMplayerType="+f+"&MMdoctitle="+K.title;if(typeof b.flashvars!=C?b.flashvars+="&"+g:b.flashvars=g,U.ie&&U.win&&4!=e.readyState){var h=q("div");c+="SWFObjectNew",h.setAttribute("id",c),e.parentNode.insertBefore(h,e),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}l(a,b,c)}}function j(a){if(U.ie&&U.win&&4!=a.readyState){var b=q("div");a.parentNode.insertBefore(b,a),b.parentNode.replaceChild(k(a),b),a.style.display="none",function(){4==a.readyState?a.parentNode.removeChild(a):setTimeout(arguments.callee,10)}()}else a.parentNode.replaceChild(k(a),a)}function k(a){var b=q("div");if(U.win&&U.ie)b.innerHTML=a.innerHTML;else{var c=a.getElementsByTagName(D)[0];if(c){var d=c.childNodes;if(d)for(var e=d.length,f=0;e>f;f++)1==d[f].nodeType&&"PARAM"==d[f].nodeName||8==d[f].nodeType||b.appendChild(d[f].cloneNode(!0))}}return b}function l(a,b,c){var d,e=p(c);if(U.wk&&U.wk<312)return d;if(e)if(typeof a.id==C&&(a.id=c),U.ie&&U.win){var f="";for(var g in a)a[g]!=Object.prototype[g]&&("data"==g.toLowerCase()?b.movie=a[g]:"styleclass"==g.toLowerCase()?f+=' class="'+a[g]+'"':"classid"!=g.toLowerCase()&&(f+=" "+g+'="'+a[g]+'"'));var h="";for(var i in b)b[i]!=Object.prototype[i]&&(h+='<param name="'+i+'" value="'+b[i]+'" />');e.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+f+">"+h+"</object>",P[P.length]=a.id,d=p(a.id)}else{var j=q(D);j.setAttribute("type",G);for(var k in a)a[k]!=Object.prototype[k]&&("styleclass"==k.toLowerCase()?j.setAttribute("class",a[k]):"classid"!=k.toLowerCase()&&j.setAttribute(k,a[k]));for(var l in b)b[l]!=Object.prototype[l]&&"movie"!=l.toLowerCase()&&m(j,l,b[l]);e.parentNode.replaceChild(j,e),d=j}return d}function m(a,b,c){var d=q("param");d.setAttribute("name",b),d.setAttribute("value",c),a.appendChild(d)}function n(a){var b=p(a);b&&"OBJECT"==b.nodeName&&(U.ie&&U.win?(b.style.display="none",function(){4==b.readyState?o(a):setTimeout(arguments.callee,10)}()):b.parentNode.removeChild(b))}function o(a){var b=p(a);if(b){for(var c in b)"function"==typeof b[c]&&(b[c]=null);b.parentNode.removeChild(b)}}function p(a){var b=null;try{b=K.getElementById(a)}catch(c){}return b}function q(a){return K.createElement(a)}function r(a,b,c){a.attachEvent(b,c),Q[Q.length]=[a,b,c]}function s(a){var b=U.pv,c=a.split(".");return c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10)||0,c[2]=parseInt(c[2],10)||0,b[0]>c[0]||b[0]==c[0]&&b[1]>c[1]||b[0]==c[0]&&b[1]==c[1]&&b[2]>=c[2]?!0:!1}function t(a,b,c,d){if(!U.ie||!U.mac){var e=K.getElementsByTagName("head")[0];if(e){var f=c&&"string"==typeof c?c:"screen";if(d&&(A=null,B=null),!A||B!=f){var g=q("style");g.setAttribute("type","text/css"),g.setAttribute("media",f),A=e.appendChild(g),U.ie&&U.win&&typeof K.styleSheets!=C&&K.styleSheets.length>0&&(A=K.styleSheets[K.styleSheets.length-1]),B=f}U.ie&&U.win?A&&typeof A.addRule==D&&A.addRule(a,b):A&&typeof K.createTextNode!=C&&A.appendChild(K.createTextNode(a+" {"+b+"}"))}}}function u(a,b){if(T){var c=b?"visible":"hidden";R&&p(a)?p(a).style.visibility=c:t("#"+a,"visibility:"+c)}}function v(a){var b=/[\\\"<>\.;]/,c=null!=b.exec(a);return c&&typeof encodeURIComponent!=C?encodeURIComponent(a):a}var w,x,y,z,A,B,C="undefined",D="object",E="Shockwave Flash",F="ShockwaveFlash.ShockwaveFlash",G="application/x-shockwave-flash",H="SWFObjectExprInst",I="onreadystatechange",J=window,K=document,L=navigator,M=!1,N=[d],O=[],P=[],Q=[],R=!1,S=!1,T=!0,U=function(){var a=typeof K.getElementById!=C&&typeof K.getElementsByTagName!=C&&typeof K.createElement!=C,b=L.userAgent.toLowerCase(),c=L.platform.toLowerCase(),d=c?/win/.test(c):/win/.test(b),e=c?/mac/.test(c):/mac/.test(b),f=/webkit/.test(b)?parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,g=!1,h=[0,0,0],i=null;if(typeof L.plugins!=C&&typeof L.plugins[E]==D)i=L.plugins[E].description,!i||typeof L.mimeTypes!=C&&L.mimeTypes[G]&&!L.mimeTypes[G].enabledPlugin||(M=!0,g=!1,i=i.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),h[0]=parseInt(i.replace(/^(.*)\..*$/,"$1"),10),h[1]=parseInt(i.replace(/^.*\.(.*)\s.*$/,"$1"),10),h[2]=/[a-zA-Z]/.test(i)?parseInt(i.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof J.ActiveXObject!=C)try{var j=new ActiveXObject(F);j&&(i=j.GetVariable("$version"),i&&(g=!0,i=i.split(" ")[1].split(","),h=[parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10)]))}catch(k){}return{w3:a,pv:h,wk:f,ie:g,win:d,mac:e}}();return!function(){U.w3&&((typeof K.readyState!=C&&"complete"==K.readyState||typeof K.readyState==C&&(K.getElementsByTagName("body")[0]||K.body))&&a(),R||(typeof K.addEventListener!=C&&K.addEventListener("DOMContentLoaded",a,!1),U.ie&&U.win&&(K.attachEvent(I,function(){"complete"==K.readyState&&(K.detachEvent(I,arguments.callee),a())}),J==top&&!function(){if(!R){try{K.documentElement.doScroll("left")}catch(b){return setTimeout(arguments.callee,0),void 0}a()}}()),U.wk&&!function(){return R?void 0:/loaded|complete/.test(K.readyState)?(a(),void 0):(setTimeout(arguments.callee,0),void 0)}(),c(a)))}(),!function(){U.ie&&U.win&&window.attachEvent("onunload",function(){for(var a=Q.length,b=0;a>b;b++)Q[b][0].detachEvent(Q[b][1],Q[b][2]);for(var c=P.length,d=0;c>d;d++)n(P[d]);for(var e in U)U[e]=null;U=null;for(var f in swfobject)swfobject[f]=null;swfobject=null})}(),{registerObject:function(a,b,c,d){if(U.w3&&a&&b){var e={};e.id=a,e.swfVersion=b,e.expressInstall=c,e.callbackFn=d,O[O.length]=e,u(a,!1)}else d&&d({success:!1,id:a})},getObjectById:function(a){return U.w3?g(a):void 0},embedSWF:function(a,c,d,e,f,g,j,k,m,n){var o={success:!1,id:c};U.w3&&!(U.wk&&U.wk<312)&&a&&c&&d&&e&&f?(u(c,!1),b(function(){d+="",e+="";var b={};if(m&&typeof m===D)for(var p in m)b[p]=m[p];b.data=a,b.width=d,b.height=e;var q={};if(k&&typeof k===D)for(var r in k)q[r]=k[r];if(j&&typeof j===D)for(var t in j)typeof q.flashvars!=C?q.flashvars+="&"+t+"="+j[t]:q.flashvars=t+"="+j[t];if(s(f)){var v=l(b,q,c);b.id==c&&u(c,!0),o.success=!0,o.ref=v}else{if(g&&h())return b.data=g,i(b,q,c,n),void 0;u(c,!0)}n&&n(o)})):n&&n(o)},switchOffAutoHideShow:function(){T=!1},ua:U,getFlashPlayerVersion:function(){return{major:U.pv[0],minor:U.pv[1],release:U.pv[2]}},hasFlashPlayerVersion:s,createSWF:function(a,b,c){return U.w3?l(a,b,c):void 0},showExpressInstall:function(a,b,c,d){U.w3&&h()&&i(a,b,c,d)},removeSWF:function(a){U.w3&&n(a)},createCSS:function(a,b,c,d){U.w3&&t(a,b,c,d)},addDomLoadEvent:b,addLoadEvent:c,getQueryParamValue:function(a){var b=K.location.search||K.location.hash;if(b){if(/\?/.test(b)&&(b=b.split("?")[1]),null==a)return v(b);for(var c=b.split("&"),d=0;d<c.length;d++)if(c[d].substring(0,c[d].indexOf("="))==a)return v(c[d].substring(c[d].indexOf("=")+1))}return""},expressInstallCallback:function(){if(S){var a=p(H);a&&w&&(a.parentNode.replaceChild(w,a),x&&(u(x,!0),U.ie&&U.win&&(w.style.display="block")),y&&y(z)),S=!1}}}}();Oktell=function(){var self=this,JSON={};!function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toOktellJSON&&(i=i.toOktellJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toOktellJSON&&(Date.prototype.toOktellJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toOktellJSON=Number.prototype.toOktellJSON=Boolean.prototype.toOktellJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var initFlashWebSocket=function(){if(window.WEB_SOCKET_FORCE_FLASH);else{if(window.WebSocket)return;if(window.MozWebSocket)return window.WebSocket=MozWebSocket,void 0}var a;return a=window.WEB_SOCKET_LOGGER?WEB_SOCKET_LOGGER:window.console&&window.console.log&&window.console.error?window.console:{log:function(){},error:function(){}},swfobject.getFlashPlayerVersion().major<10?(a.error("Flash Player >= 10.0.0 is required."),void 0):("file:"==location.protocol&&a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),window.WebSocket=function(a,b,c,d,e){var f=this;f.__id=WebSocket.__nextId++,WebSocket.__instances[f.__id]=f,f.readyState=WebSocket.CONNECTING,f.bufferedAmount=0,f.__events={},b?"string"==typeof b&&(b=[b]):b=[],f.__createTask=setTimeout(function(){WebSocket.__addTask(function(){f.__createTask=null,WebSocket.__flash.create(f.__id,a,b,c||null,d||0,e||null)})},0)},WebSocket.prototype.send=function(a){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var b=WebSocket.__flash.send(this.__id,encodeURIComponent(a));return 0>b?!0:(this.bufferedAmount+=b,!1)},WebSocket.prototype.close=function(){return this.__createTask?(clearTimeout(this.__createTask),this.__createTask=null,this.readyState=WebSocket.CLOSED,void 0):(this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id)),void 0)},WebSocket.prototype.addEventListener=function(a,b){a in this.__events||(this.__events[a]=[]),this.__events[a].push(b)},WebSocket.prototype.removeEventListener=function(a,b){if(a in this.__events)for(var c=this.__events[a],d=c.length-1;d>=0;--d)if(c[d]===b){c.splice(d,1);break}},WebSocket.prototype.dispatchEvent=function(a){for(var b=this.__events[a.type]||[],c=0;c<b.length;++c)b[c](a);var d=this["on"+a.type];d&&d.apply(this,[a])},WebSocket.prototype.__handleEvent=function(a){"readyState"in a&&(this.readyState=a.readyState),"protocol"in a&&(this.protocol=a.protocol);var b;if("open"==a.type||"error"==a.type)b=this.__createSimpleEvent(a.type);else if("close"==a.type)b=this.__createSimpleEvent("close"),b.wasClean=a.wasClean?!0:!1,b.code=a.code,b.reason=a.reason;else{if("message"!=a.type)throw"unknown event type: "+a.type;var c=decodeURIComponent(a.message);b=this.__createMessageEvent("message",c)}this.dispatchEvent(b)},WebSocket.prototype.__createSimpleEvent=function(a){if(document.createEvent&&window.Event){var b=document.createEvent("Event");return b.initEvent(a,!1,!1),b}return{type:a,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(a,b){if(document.createEvent&&window.MessageEvent&&!window.opera){var c=document.createEvent("MessageEvent");return c.initMessageEvent("message",!1,!1,b,null,null,window,null),c}return{type:a,data:b,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__initialized=!1,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(a){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(a)})},WebSocket.__initialize=function(){if(!WebSocket.__initialized){if(WebSocket.__initialized=!0,WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),!window.WEB_SOCKET_SWF_LOCATION)return a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf"),void 0;if(!window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&!WEB_SOCKET_SWF_LOCATION.match(/(^|\/)WebSocketMainInsecure\.swf(\?.*)?$/)&&WEB_SOCKET_SWF_LOCATION.match(/^\w+:\/\/([^\/]+)/)){var b=RegExp.$1;location.host!=b&&a.error("[WebSocket] You must host HTML and WebSocketMain.swf in the same host ('"+location.host+"' != '"+b+"'). "+"See also 'How to host HTML file and SWF file in different domains' section "+"in README.md. If you use WebSocketMainInsecure.swf, you can suppress this message "+"by WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR = true;")}var c=document.createElement("div");c.id="webSocketContainer",c.style.position="absolute",WebSocket.__isFlashLite()?(c.style.left="0px",c.style.top="0px"):(c.style.left="-100px",c.style.top="-100px");var d=document.createElement("div");d.id="webSocketFlash",c.appendChild(d),document.body.appendChild(c),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(b){b.success||a.error("[WebSocket] swfobject.embedSWF failed")})}},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var a=0;a<WebSocket.__tasks.length;++a)WebSocket.__tasks[a]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{for(var b=WebSocket.__flash.receiveEvents(),c=0;c<b.length;++c)WebSocket.__instances[b[c].webSocketId].__handleEvent(b[c])}catch(d){a.error(d)}},0),!0},WebSocket.__log=function(b){a.log(decodeURIComponent(b))},WebSocket.__error=function(b){a.error(decodeURIComponent(b))},WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];return a&&a.enabledPlugin&&a.enabledPlugin.filename?a.enabledPlugin.filename.match(/flashlite/i)?!0:!1:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||swfobject.addDomLoadEvent(function(){WebSocket.__initialize()}),void 0)},debugMode=!1,logStr="",log=function(){if(debugMode){var a=new Date,b=a.getFullYear()+"-"+(a.getMonth()<10?"0":"")+a.getMonth()+"-"+(a.getDate()<10?"0":"")+a.getDate(),c=(a.getHours()<10?"0":"")+a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes()+":"+(a.getSeconds()<10?"0":"")+a.getSeconds()+":"+(a.getMilliseconds()+1e3).toString().substr(1);logStr+=b+" "+c+" | ",args=["Oktell.js "+c+" |"];for(var d=0,e=arguments.length;e>d;d++)logStr+=("object"==typeof arguments[d]?JSON.stringify(arguments[d]):arguments[d])+" | ",args.push(arguments[d]);logStr+="\n\n";try{console.log.apply(console,args||[])}catch(f){debugMode=!1}}},md5=function(a){var b,c,d,e,f,g,h,i,j,k,l=function(a,b){return a<<b|a>>>32-b},m=function(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f},n=function(a,b,c){return a&b|~a&c},o=function(a,b,c){return a&c|b&~c},p=function(a,b,c){return a^b^c},q=function(a,b,c){return b^(a|~c)},r=function(a,b,c,d,e,f,g){return a=m(a,m(m(n(b,c,d),e),g)),m(l(a,f),b)},s=function(a,b,c,d,e,f,g){return a=m(a,m(m(o(b,c,d),e),g)),m(l(a,f),b)},t=function(a,b,c,d,e,f,g){return a=m(a,m(m(p(b,c,d),e),g)),m(l(a,f),b)},u=function(a,b,c,d,e,f,g){return a=m(a,m(m(q(b,c,d),e),g)),m(l(a,f),b)},v=function(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=new Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=8*(i%4),g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=8*(i%4),g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g},w=function(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=255&a>>>8*c,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d},x=[],y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(x=v(a),h=1732584193,i=4023233417,j=2562383102,k=271733878,b=x.length,c=0;b>c;c+=16)d=h,e=i,f=j,g=k,h=r(h,i,j,k,x[c+0],y,3614090360),k=r(k,h,i,j,x[c+1],z,3905402710),j=r(j,k,h,i,x[c+2],A,606105819),i=r(i,j,k,h,x[c+3],B,3250441966),h=r(h,i,j,k,x[c+4],y,4118548399),k=r(k,h,i,j,x[c+5],z,1200080426),j=r(j,k,h,i,x[c+6],A,2821735955),i=r(i,j,k,h,x[c+7],B,4249261313),h=r(h,i,j,k,x[c+8],y,1770035416),k=r(k,h,i,j,x[c+9],z,2336552879),j=r(j,k,h,i,x[c+10],A,4294925233),i=r(i,j,k,h,x[c+11],B,2304563134),h=r(h,i,j,k,x[c+12],y,1804603682),k=r(k,h,i,j,x[c+13],z,4254626195),j=r(j,k,h,i,x[c+14],A,2792965006),i=r(i,j,k,h,x[c+15],B,1236535329),h=s(h,i,j,k,x[c+1],C,4129170786),k=s(k,h,i,j,x[c+6],D,3225465664),j=s(j,k,h,i,x[c+11],E,643717713),i=s(i,j,k,h,x[c+0],F,3921069994),h=s(h,i,j,k,x[c+5],C,3593408605),k=s(k,h,i,j,x[c+10],D,38016083),j=s(j,k,h,i,x[c+15],E,3634488961),i=s(i,j,k,h,x[c+4],F,3889429448),h=s(h,i,j,k,x[c+9],C,568446438),k=s(k,h,i,j,x[c+14],D,3275163606),j=s(j,k,h,i,x[c+3],E,4107603335),i=s(i,j,k,h,x[c+8],F,1163531501),h=s(h,i,j,k,x[c+13],C,2850285829),k=s(k,h,i,j,x[c+2],D,4243563512),j=s(j,k,h,i,x[c+7],E,1735328473),i=s(i,j,k,h,x[c+12],F,2368359562),h=t(h,i,j,k,x[c+5],G,4294588738),k=t(k,h,i,j,x[c+8],H,2272392833),j=t(j,k,h,i,x[c+11],I,1839030562),i=t(i,j,k,h,x[c+14],J,4259657740),h=t(h,i,j,k,x[c+1],G,2763975236),k=t(k,h,i,j,x[c+4],H,1272893353),j=t(j,k,h,i,x[c+7],I,4139469664),i=t(i,j,k,h,x[c+10],J,3200236656),h=t(h,i,j,k,x[c+13],G,681279174),k=t(k,h,i,j,x[c+0],H,3936430074),j=t(j,k,h,i,x[c+3],I,3572445317),i=t(i,j,k,h,x[c+6],J,76029189),h=t(h,i,j,k,x[c+9],G,3654602809),k=t(k,h,i,j,x[c+12],H,3873151461),j=t(j,k,h,i,x[c+15],I,530742520),i=t(i,j,k,h,x[c+2],J,3299628645),h=u(h,i,j,k,x[c+0],K,4096336452),k=u(k,h,i,j,x[c+7],L,1126891415),j=u(j,k,h,i,x[c+14],M,2878612391),i=u(i,j,k,h,x[c+5],N,4237533241),h=u(h,i,j,k,x[c+12],K,1700485571),k=u(k,h,i,j,x[c+3],L,2399980690),j=u(j,k,h,i,x[c+10],M,4293915773),i=u(i,j,k,h,x[c+1],N,2240044497),h=u(h,i,j,k,x[c+8],K,1873313359),k=u(k,h,i,j,x[c+15],L,4264355552),j=u(j,k,h,i,x[c+6],M,2734768916),i=u(i,j,k,h,x[c+13],N,1309151649),h=u(h,i,j,k,x[c+4],K,4149444226),k=u(k,h,i,j,x[c+11],L,3174756917),j=u(j,k,h,i,x[c+2],M,718787259),i=u(i,j,k,h,x[c+9],N,3951481745),h=m(h,d),i=m(i,e),j=m(j,f),k=m(k,g);var O=w(h)+w(i)+w(j)+w(k);return O.toLowerCase()},utf8Decode=function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(a+="";c<a.length;)e=a.charCodeAt(c),128>e?(b[d++]=String.fromCharCode(e),c++):e>191&&224>e?(f=a.charCodeAt(c+1),b[d++]=String.fromCharCode((31&e)<<6|63&f),c+=2):(f=a.charCodeAt(c+1),g=a.charCodeAt(c+2),b[d++]=String.fromCharCode((15&e)<<12|(63&f)<<6|63&g),c+=3);return b.join("")},utf8DecodePass=function(a){for(var b="",c=0,d=0;d<a.length;d++)c=a.charCodeAt(d),c>127?c>1024&&(1025==c?c=1016:1105==c&&(c=1032),b+=String.fromCharCode(c-848)):b+=a.charAt(d);return b},base64_decode=function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a+="";do e=j.indexOf(a.charAt(k++)),f=j.indexOf(a.charAt(k++)),g=j.indexOf(a.charAt(k++)),h=j.indexOf(a.charAt(k++)),i=e<<18|f<<12|g<<6|h,b=255&i>>16,c=255&i>>8,d=255&i,n[l++]=64==g?String.fromCharCode(b):64==h?String.fromCharCode(b,c):String.fromCharCode(b,c,d);while(k<a.length);return m=n.join(""),m=utf8Decode(m)},extend=function(a){var b=Array.prototype.slice.call(arguments,1);return each(b,function(b){each(b,function(c,d){b.hasOwnProperty(d)&&(a[d]=c)})}),a},isArray=function(a){return Array.isArray?Array.isArray(a):"[object Array]"==Object.prototype.toString.call(a)},cloneObject=function(a,b){if(b)return JSON.parse(JSON.stringify(a));var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]="object"==typeof a[d]?cloneObject(a[d],!1):a[d]);return c},size=function(a){if(a=a||[],isArray(a))return a.length;if(a===Object(a)){if(Object.keys)return Object.keys(a).length;var b=0;for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b++;return b}return!1},breaker={},each=function(a,b,c){if(null!=a)if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(d in a&&b.call(c,a[d],d,a)===breaker)return}else for(var f in a)if(Object.prototype.hasOwnProperty.call(a,f)&&b.call(c,a[f],f,a)===breaker)return},trim=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},formatPhone=function(a){if(!a)return"";a=a.toString().split(";").join(",");for(var b=a.split(","),c=0;c<b.length;c++){b[c]=trim(b[c]);var d,e="",f="",g="";if(""!=b[c]){if(-1!=b[c].indexOf("(")){var h=b[c].split("(");e=trim(h[0]),h=h[1].split(")"),f=trim(h[0]);var d=trim(h[1]);d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),-1==d.indexOf("-")&&(h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")],d=trim(h[0]),g=trim(h[1]),5==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)),6==d.length&&(d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2)),7==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2)),""!=g&&(d+=" "+g))}else{d=b[c].split("+").join(""),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2");var h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")];d=trim(h[0]),d=d.split("-").join(""),d=d.split("—").join(""),g=trim(h[1]),5==d.length?d=d.substr(0,3)+"-"+d.substr(3,2):6==d.length?d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2):7==d.length?d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2):9==d.length?(f=d.substr(0,3),d=d.substr(3,2)+"-"+d.substr(5,2)+"-"+d.substr(7,2)):10==d.length?(f=d.substr(0,3),d=d.substr(3,3)+"-"+d.substr(6,2)+"-"+d.substr(8,2)):11==d.length?(e=d.substr(0,1),f=d.substr(1,3),d=d.substr(4,3)+"-"+d.substr(7,2)+"-"+d.substr(9,2)):12==d.length?(e=d.substr(0,2),f=d.substr(2,3),d=d.substr(5,3)+"-"+d.substr(8,2)+"-"+d.substr(10,2)):13==d.length?(e=d.substr(0,3),f=d.substr(3,3),d=d.substr(6,3)+"-"+d.substr(9,2)+"-"+d.substr(11,2)):14==d.length&&(e=d.substr(0,4),f=d.substr(4,3),d=d.substr(7,3)+"-"+d.substr(10,2)+"-"+d.substr(12,2)),""!=g&&(d+=" "+g)}"8"==e&&(e="+7"),"+"!=e[0]&&""!=e&&(e="+"+e);var i=[];""!=e&&i.push(e),""!=f&&i.push("("+f+")"),""!=d&&i.push(d),b[c]=i.join(" ")}}return a=b.join(", ")},newGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})},buildParams=function(a){if("object"==typeof a){var b="";return each(a,function(a,c){b+="&"+c+"="+a.toString()}),b}return!1},isGuid=function(a){return"string"==typeof a&&a.match(/[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}/)||32==a.length&&a.match(/[a-zA-Z0-9]{32}/)?!0:!1},callFunc=function(a){"function"==typeof a&&a.apply(void 0,Array.prototype.slice.call(arguments,1))},dateToIso=function(a){return a instanceof Date?a.getFullYear()+"-"+(a.getMonth()<10?"0"+a.getMonth():a.getMonth())+"-"+(a.getDate()<10?"0"+a.getDate():a.getDate()):!1},cookie=function(a,b,c){if(arguments.length>1&&"[object Object]"!==String(b)){if(c=extend({},c),(null===b||void 0===b)&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setSeconds(e.getSeconds()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null},eventSplitter=/\s+/,normalizeEventNames=function(a){if("string"==typeof a)a=a.replace(/,/g," ").split(eventSplitter);else{if(!(isArray(a)&&a.length>0))return!1;for(var b=[],c=0;c<a.length;c++){var d=a[c];d&&"string"==typeof d&&b.push(d)}eventsNames=b}return a},Events={on:function(a,b,c){if(a=normalizeEventNames(a),!a||"function"!=typeof b)return!1;var d=this._callbacks||(this._callbacks={});return each(a,function(a){if("string"!=typeof a)return breaker;var e=d[a]||(d[a]=[]);e.push({callback:b,context:c})}),!0},off:function(a,b){var c=this._callbacks||(this._callbacks={});if(a){if(a=normalizeEventNames(a),!a)return!1;"function"==typeof b?each(a,function(a){"string"==typeof a&&each(c[a],function(d,e){d&&d.callback===b&&delete c[a][e]})}):each(a,function(a){delete c[a]})}else c={};return!0},trigger:function(a){a=normalizeEventNames(a);var b=this._callbacks||(this._callbacks={});if(!a)return!1;var c=Array.prototype.slice.call(arguments,1),d=b.all;return each(a,function(a){var e=b[a];if(e&&each(e,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,c)}),d){var f=[a].concat(c);each(d,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,f)})}}),!0}},Server=function(a,b,c,d,e){var f,g={},h=/^ws[s]{0,1}:\/\/\S+$/i,i=this,j=!1,k=!1,l={},m={},n={},o={},p={dynamic:["executemethod","cancelmethod"],dynamicwaitabort:["executemethodwaitaborted"],chat:["chatmessageviewed","chatmessage","chatmemberremoved","chatmemberadded","chatnamechanged","chatcreated"],dlgcard:["dlgcard_showreserve","dlgcard_showconfirm","dlgcard_showformstop","dlgcard_showformdialog","dlgcard_closeall","dlgcard_closereserve","dlgcard_closeformreturnvalues","dlgcard_closeformreturncomment"]};i.setQueryDelayMin(c),i.setQueryDelayMax(d);var q=function(a){if(!isArray(a))return!1;for(var b,c="https:"==location.protocol?!0:!1,d=80,e=[],f=a.length;f>b;b++){if("string"!=typeof a[b])return!1;if(h.text(a[b]))e.push(a[b]);else{var g=a[b].split(":"),i=g[0],j=g[1];j||(j=d,e.push(i+":"+"4066")),"443"==j&&(c=!0),e.push(i+":"+j)}}for(var b,k=c?"wss://":"ws//",f=e.length;f>b;b++)h.text(a[b])||(e[b]=k+e[b])},r=function(){},s=function(){},s=function(){},t=!1,u=function(a){if(t)a.close();else{t=!0,f=a;var b=Math.random().toString();f.onmessage=function(c){var d=JSON.parse(c.data),e=function(a){i.ws=a,a.onmessage=x,a.onclose=r,a.onerror=s,w()};if("websocketredirect"==d[0]){var f=new WebSocket(a.url.replace("ws://","wss://").replace(":4066",":443"),"json");f.onopen=function(){e(f)}}else d[1]&&d[1].qid==b&&e(a)},f.send(JSON.stringify(["ping",{qid:b}]))}};i.n_connect=function(){for(var b,c=q(a),d=c.length;d>b;b++)setTimeout(function(){var a=new WebSocket(c[b],"json");a.onopen=function(){u(a)},a.onerror=function(){},a.onclose=function(){}},1)},i.url=a;var v=function(){k||(k=!0,i.trigger("errorConnection"))},w=function(){j=!0,"function"==typeof e&&(log("success connect to "+f.url),e(f.url))},x=function(a){var b=JSON.parse(a.data);z(b);var c=!1;if("multipart"==b[0]){var d=m[b[1]["message-id"]];if(d||(d={packetcount:b[1].packetcount,content:[],value:""},m[b[1]["message-id"]]=d),d.content[parseInt(b[1].packetnumber)]=b[1].content.toString(),d.content.length==d.packetcount){for(var e=0;e<d.content.length;e++)d.value=""+d.value+base64_decode(d.content[e]);c=!0}}if(("multipart"!=b[0]||"multipart"==b[0]&&c)&&(c&&(b=JSON.parse(m[b[1]["message-id"]].value)),"function"==typeof l[b[1].qid])){var f=l[b[1].qid];delete l[b[1].qid];var g=b[1];void 0===g.result&&(g.result=1),f(b[1])}},y=function(){j?k||i.trigger("connectionClose"):v(),o={}};i.multiConnect=function(){isArray(a)||(a=[a]),log("Multi connect start",a);var c=0;a=a.slice(0,10),each(a,function(d){setTimeout(function(){try{g[d]=new WebSocket(d,"json"),log("trying to connect "+d),g[d].onopen=function(){g[d].wasOpened=!0;var a=Math.random().toString();g[d].send(JSON.stringify(["ping",{qid:a}])),g[d].onmessage=function(b){if(j)return!1;var c=JSON.parse(b.data),e=function(){i.url=d,i.wsUrl=f=g[d],f.onmessage=x,f.onclose=y,w()};if("websocketredirect"==c[0]){var h=d.replace(/^ws:\/\//,"wss://").replace(/:[0-9]{1,5}/,":443");log("redirect to secure websocket, trying to connect "+h),g[d].close(),d=h;var k=new WebSocket(d,"json");k.onopen=function(){return j?!1:(e(),void 0)},g[d]=k}else c[1]&&c[1].qid==a&&e()}},setTimeout(function(){(1!=i.getWebSocketState(g[d])&&!g[d].wasOpened||i.url!=d)&&(i.disconnect(g[d]),c++,c==a.length&&(c=-999,v()))},b)}catch(e){return c++,c==a.length&&(c=-999,i.trigger("errorConnection",e)),breaker}},1)})},i.connect=function(){k=!1;try{log("trying to connect "+a),f=new WebSocket("ws://"+a,"json"),setTimeout(function(){0==i.getWebSocketState()&&(i.disconnect(),v())},b)}catch(c){return i.trigger("errorConnection",c),!1
}f.onopen=w,f.onmessage=x,f.onclose=y},i.send=function(a,b,c){return JSON.parse(a),"function"==typeof c&&(l[b]=c),i.delayMin>0?(timeout=i.delayMin,d&&(timeout=Math.round(Math.random()*Math.abs(i.delayMax-i.delayMin)+i.delayMin)),setTimeout(function(){f.send(a)},timeout),!0):f.send(a)},i.sendOktell=function(a,b,c){b=b||{};var d=new Array;d.push(a),b.qid=Math.random().toString(),d.push(b),i.send(JSON.stringify(d),d[1].qid,c)===!1&&callFunc(c,{result:0,errormsg:"websocket send error"})},i.execProc=function(a,b,c){var d=["execpredefineddbstoredproc",extend({qid:Math.random().toString(),procedure:a},b)];i.send(JSON.stringify(d),d[1].qid,function(a){var b=[];if(1==a.result&&0==a.errorcode)for(var d=0;d<a.dataset.length;d++){var e=[];b.push(e);for(var f=[],g=0;g<a.dataset[d][0].length;g++)f.push(a.dataset[d][0][g]);for(var h=1;h<a.dataset[d].length;h++){for(var i={},j=0;j<f.length;j++)i[f[j]]=a.dataset[d][h][j];e.push(i)}}else b=!1;callFunc(c,b,a.dataset)})},i.bindOktellEvent=function(a,b){return a=normalizeEventNames(a),a&&"function"==typeof b?(each(a,function(a){n[a]||(n[a]=[]),n[a].push(b)}),i.sendOktellEventSubscription(a),!0):!1};var z=function(a){n&&n[a[0]]&&(log("<<< EVENT "+a[0],a[1]),each(n[a[0]],function(b){callFunc(b,a[1])}))};i.sendOktellEventSubscription=function(a,b){var c=this;if(a=normalizeEventNames(a),!a)return!1;var d=[];each(a,function(a){o[a]||(d.push(a),isArray(p[a])&&c.sendOktellEventSubscription(p[a],!0)),b&&(o[a]=!0)}),!b&&d.length&&(log("===> Event subscription",d),c.sendOktell("subscribeevent",{eventmethod:d},function(a){log("<=== Event subscribtion result: "+a.result,d),each(d,function(a){o[a]=!0})}))},i.unbindOktellEvent=function(a,b){if(a){if(a=normalizeEventNames(a),!a)return!1;b="function"==typeof b?b:!1;for(var c=0;c<a.length;c++){var d=a[c];b?each(n[d],function(a,c){a===b&&delete n[d][c]}):delete n[d]}}else n={};return!0},i.reSendOktellEventSubscribtions=function(){var a=[];each(o,function(b,c){b&&a.push(c)}),a.length&&i.sendOktell("subscribeevent",{eventmethod:a},function(){})},i.disconnect=function(a){a=a||f,a.close();var b=i.getWebSocketState(a);return 3==b||2==b?!0:!1},i.getWebSocketState=function(a){return a=a||f,a?a.readyState:void 0}};Server.prototype.setQueryDelayMin=function(a){a=parseInt(a),a&&(this.delayMin=a)},Server.prototype.setQueryDelayMax=function(a){a=parseInt(a),a&&(this.delayMax=a)},extend(Server.prototype,Events);var Abonent=function(){},Oktell=function(){var a,b,c,d,e,f=this,g=!1,h=[],i={openTimeout:1e4,queryTimeout:2e4,queueInterval:5e3,oktellVoice:!1,webSocketSwfLocation:"WebSocketMain.swf"},j=!1,k={redirectNumber:void 0,allowedProcedures:{}},l={getmyuserinfo:{v:120327,critical:!0},getversion:{v:120112,critical:!0},pbxmakeflash:{v:120725},getextendedlineinfo:{v:120112,critical:!0},getflashedabonentinfo:{v:120112,critical:!0},saveredirectrules:{v:120725},deleteredirectrules:{v:120725},getredirectrules:{v:120725},pbxmaketransfer:{v:120725},triggercustomevent:{v:120725},getallusernumbers:{v:120920},cc_getlunchtypes:{v:130101},pbxanswercall:{v:131218}},m={},n="___oktellsessionid",o={},p={},q={},r=!1,s=function(a,b,c){f[a]||"function"!=typeof b||(f[a]=function(){return b.apply(c||f,arguments)})},t=function(a){return void 0!==a&&(g=a?!0:!1),g},u=extend({},Events),v=function(){return a&&1==a.getWebSocketState()?!0:!1},w=function(a,b){if(void 0===a||!size(b))return!1;a=parseInt(a);var c="";return each(b,function(b,d){b==a&&(c=d.toLowerCase())}),c},x=function(a){if(!a||"string"!=typeof a&&"number"!=typeof a&&!isArray(a))return!1;("string"==typeof a||"number"==typeof a)&&(a=[a.toString()]);var b=!0;return each(a,function(a){return"string"!=typeof a?(b=!1,breaker):void 0}),b?a:!1},y=function(a){return k.oktellDated&&l[a]&&k.oktellDated<l[a].v?!1:!0},z={10:"critical ws method not supported by this version of Oktell server",11:"error loading version info",12:"websocket connection closed",13:"disconnected by user",14:"can't login using oktell.connect"},A=function(a,b){return{code:a,message:z[a]+" "+(b||"")||""}},B={1e3:"something goes wrong",1101:"method not supported by current Oktell version",1102:"server didnt understand method or response timeout",1103:"error execute method",1104:"bad method for execute",1105:"error execute stored procedure",1106:"bad params",1200:"cant connect to server",1201:"error websocket connection",1202:"error loginpass",1203:"oktell version too old",1204:"using oktell desktop client",1205:"error url",1206:"error loading version info",1207:"error loading phone state",1209:"error loading user state",1210:"error loading user info",1211:"login failure",1212:"error connect using session",1213:"no password or session",1214:"max online users count reached, license limitation",2001:"user state - disconnected",2002:"phone not connected",2101:"user has hold call and is talking now",2102:"user in conference now",2103:"phone state not valid for call",2104:"user state - busy",2105:"calling number is talking with us",2106:"bad number",2107:"error autocall method call",2108:"error user or phone state for call",2201:"no numbers to invite",2202:"cant build conference from current call",2203:"no number to create conference",2204:"error conference method call",2205:"bad user or phone state for creating conference",2206:"cant invite hold abonent",2207:"error inviting",2208:"cant create conference while in callcenter in break",2301:"error transfer method call",2302:"bad user or phone state for transfer",2303:"nothing to transfer",2304:"bad number for transfer",2401:"error toggle method executing",2402:"nothing to toggle, no hold",2501:"not in conference",2502:"server retunred error while enabling ghost mode",2503:"bad ghost mode",2504:"bad userId or number",2505:"error rigths",2506:"user is not in ghost mode",2507:"cant change ghost mode of this user",2601:"bad flash mode",2602:"error while exec flash method",2701:"error while loading user queue",2801:"wrong old password",2802:"incorrect new password",2803:"error while exec changepassword method on server",2901:"incorrect state",2902:"phone probably does not support intercom calls",3001:"error while getting temp pass",3002:"aborted in beforeRequest callback function"},C=function(a,b,c){a=parseInt(a);var d=extend(c||{},{result:!1,errorCode:a,errorMessage:(B[a]?B[a]:"")+(b?b.toString():"")});return log("ERROR "+a+" "+d.errorMessage,d),d},D=function(a){var b=extend(a||{},{result:!0});return log("SUCCESS ",b),b},E=function(a,b,c,d){return a?D(b):C(c,d,b)},F=function(b,c){b=normalizeEventNames(b),evObjs=[];for(var d=0;d<b.length;d++){for(var e=b[d],f=!1,g=0;g<h.length;g++){var i=h[g];if(i&&i.eventName==e&&i.callback===c){f=!0;break}}if(f)b[d]=void 0;else{var j={eventName:e,callback:c};h.push(j),evObjs.push(j)}}if(t()){for(var d=0;d<evObjs.length;d++)evObjs[d].binded=!0;a.bindOktellEvent(b,c)}},G=function(b,c){if(b){if(b=normalizeEventNames(b),!b)return!1;c="function"==typeof c?c:!1;for(var d=0;d<b.length;d++)for(var e=b[d],f=0;f<h.length;f++){var g=h[f];g&&g.eventName==e&&(c&&g.callback===c||!c)&&(h[f]=void 0)}}else h=[];a.unbindOktellEvent(b,c)},H=function(b,c,d){var e="function"==typeof c?c:d;if(v())if(y(b)){c=size(c)?c:{};var f,c=extend({userlogin:k.login},c);if("function"==typeof e)var f=setTimeout(function(){log("error timer for method "+b),callFunc(e,C(1102,": "+b))},i.queryTimeout);a.sendOktell(b,c,function(a){clearTimeout(f),log("<<<< "+b,a),callFunc(e,a)}),log(">>>> "+b,c)}else callFunc(e,C(1101," "+b)),l[b].critical&&bb(A(10),b);else callFunc(e,C(1201))},I=function(b,c,d){var e="function"==typeof c?c:d;if(b)if(k.allowedProcedures[b.toLowerCase()]){var f={userid:k.userid,userlogin:k.login,inputparams:c||{}};log(">>>> "+b,f),a.execProc(b,f,function(a,c){var d={result:!1};a&&(d.result=!0,d.datasets=a,d.datasetsRaw=c),log("<<<< "+b,d),callFunc(e,E(d.result,d,1105," "+b))})}else e?H(b,c,function(a){var c=a.errorCode?E(a.result,a,a.errorCode):E(a.result,a,1103," "+b);callFunc(e,c)}):H(b,c);else callFunc(e,C(1104))};s("exec",I);var J=extend({sendCustomBinding:function(){if(this._subscribed)return!1;this._subscribed=!0;var b=this;a.bindOktellEvent("customevent",function(a){a&&a.eventname&&b.trigger(a.eventname,a.eventparam)})},triggerCustomEvent:function(a,b,c,d){H("triggercustomevent",{userid:k.userid,userlogin:k.login,eventname:a,eventparam:c,recipients:b,sendback:d?1:"0"})}},Events);s("triggerCustomEvent",J.triggerCustomEvent,J),s("offCustomEvent",J.off,J),s("onCustomEvent",J.on,J);var K=function(a){H("getallusernumbers",{fillsubordinates:!0},function(b){b.result&&b.users?(each(b.users,function(a){o[a.id]={id:a.id,name:a.name,number:a.main||void 0,numbers:a.nums||[],controlledByMe:a.sub?!0:!1},o[a.id].numberObj=p[o[a.id].number]||void 0,o[a.id].numberObj&&(o[a.id].numberObj.userid=a.id,o[a.id].numberObj.userObj=o[a.id])}),H("getalluserphotolink",{mode:"page"},function(b){if(b.result){var c=N();each(b.links,function(a){var b=a.id==k.userid?k:o[a.id];b&&(b.avatarLink=a.link?c+a.link32x32:i.defaultAvatar||"",b.avatarLink32x32=a.link32x32?c+a.link32x32:i.defaultAvatar32x32||"",b.avatarLink96x96=a.link96x96?c+a.link96x96:i.defaultAvatar64x64||"")})}callFunc(a)})):callFunc(a)})},L=function(a){return a?(a=a.toString())&&o[a]&&o[a].id?o[a].controlledByMe:p[a]&&p[a].userObj?p[a].userObj.controlledByMe:!1:!1},M=function(a){H("getpbxnumbers",{mode:"full"},function(b){b.result&&b.numbers&&each(b.numbers,function(a){p[a.number]=a,q[a.id]=p[a.number]}),callFunc(a)})},N=function(){if(k.currentUrl&&k.oktellWebServerPort){var a=k.currentUrl.match(/^wss/)?"https://":"http://",b=k.currentUrl.match(/wss?:\/\/([^\s\/:]+)/)[1];return port="",("https://"==a&&"443"!=f.getMyInfo().oktellWebServerPort||"http://"==a&&"80"!=f.getMyInfo().oktellWebServerPort)&&(port=":"+f.getMyInfo().oktellWebServerPort),a+b+port}return!1},O=function(a,b){a&&(m[a]={time:(new Date).getTime(),callback:b})},P=function(a,b){H("gettemphttppass",{responsetowebsock:a?!0:!1},function(a){a.result?callFunc(b,D(a)):callFunc(b,C(1103," gettemphttppass",a))})},Q=function(a,b){if(a){var c=a.toString().split(".");c.length<2||-1==["jpg","gif","png","jpeg"].indexOf(c[c.length-1])||H("setmyuserphoto",{filepath:a},function(a){callFunc(b,E(a.result,{},1103," setmyuserphoto"))})}};s("setUserAvatar",Q);var R=function(a){H("getuserphoto",{mode:"page"},function(b){if(b.result){var c=N();k.avatarLink=b.link?c+b.link32x32:i.defaultAvatar||"",k.avatarLink32x32=b.link32x32?c+b.link32x32:i.defaultAvatar32x32||"",k.avatarLink96x96=b.link96x96?c+b.link96x96:i.defaultAvatar64x64||"",callFunc(a,D({avatarLink:k.avatarLink,avatarLink32x32:k.avatarLink32x32,avatarLink96x96:k.avatarLink96x96}))}else callFunc(a,C(1103," getuserphoto"))})};s("getUserAvatar",R);var S=function(a,b,c){var d=window.$||window.jQuery||void 0;if(!d)return T.apply(f,arguments);var e=a.accept;delete a.accept,e?(isArray(e)||(e=[e]),e='accept="'+e.join(",")+'"'):e="";var g=Math.random().toString().replace(".",""),h="_oktelljs_user_avatar_frame_"+g,i="_oktelljs_user_avatar_form_"+g,j="_oktelljs_user_profile_select_file_"+g;d("body").append('<iframe width="0" height="0" id="'+h+'" name="'+h+'"></iframe>'),d("body").append('<form enctype="multipart/form-data" target="'+h+'" id="'+i+'" action="" method="post">'+'<input style="visibility: hidden;" type="file" '+e+' name="file" id="'+j+'" /></form>');var k=function(a){d("#"+i).remove(),d("#"+h).remove(),callFunc(b,a)};d("#"+j).change(function(b){var e=d(b.currentTarget).val();if(e){var f=e.replace("/","\\").split("\\");return f=f[f.length-1],"function"==typeof c&&c(D({fileName:f}))===!1?(k(C(3002)),void 0):(P(!0,function(b){b.result?(d("#"+i).attr("action",N()+"/upload?temppass="+b.password+buildParams(a)),O(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),k(D({path:c})),void 0):!1}),d("#"+i).submit()):k(C(3001))}),void 0)}}),d("#"+j).click()},T=function(a,b){var c=Math.random().toString().replace(".",""),d="_oktelljs_user_avatar_frame_"+c,e="_oktelljs_user_avatar_form_"+c,f="_oktelljs_user_profile_select_file_"+c,g=a.accept;delete a.accept,g?(isArray(g)||(g=[g]),g='accept="'+g.join(",")+'"'):g="";var h=document.createElement("iframe");h.id=d,h.name=d,h.width=0,h.height=0,document.body.appendChild(h);var i=document.createElement("form");i.id=e,i.style.display="none",i.target=d,i.enctype="multipart/form-data",i.action="",i.method="post",document.body.appendChild(i);var j=document.createElement("input");j.style.visibility="hidden",j.type="file",j.id=f,j.name="file",j.accept=g,i.appendChild(j);var k=function(a){var c;(c=document.getElementById(d)).parentNode.removeChild(c),(c=document.getElementById(e)).parentNode.removeChild(c),callFunc(b,a)};j.onchange=function(){var b=j.value;if(b){var c=b.replace("\\","/").split("/");return c=c[c.length-1],"function"==typeof beforeRequest&&beforeRequest(D({fileName:c}))===!1?(k(C(3002)),void 0):(P(!0,function(b){b.result?(i.action=N()+"/upload?temppass="+b.password+"&"+buildParams(a),O(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),k(D({path:c})),void 0):!1}),i.submit()):k(C(3001))}),void 0)}},j.click()};s("uploadFile",S);var U=function(){function a(a,b){var c=this;c.oktell=a,c.server=b,c.currentMethods={},c.methodTimers={},c.onExecuteMethod=function(b){return b.executionid?(c.currentMethods[b.executionid]=!0,a.trigger(""),void 0):!1},c.onCancelMethod=function(a){return a.executionid?(delete c.currentMethods[a.executionid],void 0):!1},c.onExecuteMethodWaitAborted=function(a){return a.executionid?(c.currentMethods[a.executionid]=!0,c.methodTimers[a.executionid]=setTimeout(function(){delete c.currentMethods[a.executionid]},a.waitresponsems),void 0):!1}}return a.prototype.init=function(){var a=this;a.server.bindOktellEvent("dynamic",function(){}),a.server.bindOktellEvent("dynamicwaitabort",function(){}),a.server.bindOktellEvent("executemethod",a.onExecuteMethod,a),a.server.bindOktellEvent("cancelmethod",a.onCancelMethod,a),a.server.bindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted,a)},a.prototype.sendMethodResult=function(a,b){var c=this;return c.currentMethods[a]?(delete c.currentMethods[a],H("methodresult",{executionid:a,outputparameters:b||{}}),void 0):!1},a.prototype.reset=function(){var a=this;a.currentMethods={};for(var b in a.methodTimers)a.methodTimers.hasOwnProperty(b)&&clearTimeout(a.methodTimers[b]);a.server.unbindOktellEvent("executemethod",a.onExecuteMethod),a.server.unbindOktellEvent("cancelmethod",a.onCancelMethod),a.server.unbindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted)},a}();extend(U.prototype,Events),new U;var V=extend({},Events,{_stateId:0,states:{DISCONNECTED:0,READY:1,BREAK:2,OFF:3,BUSY:5,RESERVED:6,NOPHONE:7},webStates:{READY:1,DND:2,REDIRECT:3,BREAK:4},onCallCenter:0,_onRedirect:!1,_status:0,_webStateId:0,onBreak:0,breakReasons:{},loadBreakReasons:function(a){var b=this;H("cc_getlunchtypes",{},function(c){c.result&&each(c.items,function(a){b.breakReasons[a.id.toString()]=a}),callFunc(a,E(c.result,c,1103," cc_getlunchtypes"))})},getStateStr:function(a){return w(void 0===a?this._stateId:parseInt(a),this.states)},getWebStateStr:function(a){return w(void 0===a?this._webStateId:parseInt(a),this.webStates)},state:function(a){return a=parseInt(a),this.getStateStr(a)&&this._stateId!==a&&(log("SET USER STATE "+a+" "+this.getStateStr(a)),this._stateId=a,this.trigger("userStateChange",this._stateId)),this._stateId},changeStates:function(a,b,c){if(a=this.webStates[a.toString().toUpperCase()]||parseInt(a),!this.getWebStateStr(a))return!1;if(a==this._webStateId&&!this.setAfterBusy||!v())return!1;var d=this.state();switch(a){case 1:d==this.states.BUSY?this.setAfterBusy=this.webStates.READY:H("setuserstate",{userstateid:1});break;case 2:d==this.states.BUSY?this.setAfterBusy=this.webStates.DND:(d==this.states.READY||d==this.states.BREAK||d==this.states.OFF)&&H("setuserstate",{userstateid:3});break;case 3:if(!this.getRedirectNumber())return!1;this.enableUserRedirectState(!0);break;case 4:if(this.onCallCenter){var e={userstateid:2};c&&(this.breakReasons[c]?e.lunchreasonid=c:e.lunchreasonmsg=c),H("setuserstate",e)}}return this.webState(a,b),!0},webState:function(a,b){if(void 0!==a&&this.getWebStateStr(a)&&this._webStateId!=a){log("SET WEB STATE "+this.getWebStateStr(a));var c=this.getWebStateStr(this._webStateId);this._webStateId=a,b||f.trigger("statusChange",this.getWebStateStr(this._webStateId),c)}return this._webStateId},onRedirect:function(a){return void 0!==a&&(a=a?!0:!1,this._onRedirect!==a&&(this._onRedirect=a,u.trigger("userOnRedirectChanged",this._onRedirect))),this._onRedirect},loadState:function(a){var b=this;H("getuserstate",{},function(c){c.result&&b.saveStatesFromServer(c),callFunc(a,E(c.result,c,1103," getuserstate"))})},callCenterState:function(a){return void 0!==a&&(a=a?!0:!1,this.onCallCenter!==a&&(this.onCallCenter=a,f.trigger("callCenterStateChange",this.onCallCenter))),this.onCallCenter},saveStatesFromServer:function(a){this.callCenterState(a.oncallcenter),this.onBreak=a.onlunch,this.onRedirect(a.onredirect);var b=this.webState(),c=this.state();return this.state(a.userstateid),b==this.webStates.DND&&this.setAfterBusy==this.webStates.DND&&5==c&&1==a.userstateid?(this.setAfterBusy=!1,this.changeStates(this.webStates.DND,!0),void 0):(this.setWebStateFromUserState(),void 0)},setUserStateBusy:function(){this.state(5)},getUserRedirectId:function(){return md5(k.userid.toLocaleLowerCase()+k.userid.toLocaleLowerCase()).toLowerCase()},getRedirectNumber:function(){return k.redirectNumber?k.redirectNumber:void 0},setRedirectNumber:function(a){return k.redirectNumber=a?a:void 0,k.redirectNumber},checkUserRedirect:function(a){var b=this;H("getredirectrules",{},function(c){c.result&&c.redirectrules&&c.redirectrules.length>0&&each(c.redirectrules,function(a){a.id.replace(/-/g,"").toLowerCase()==b.getUserRedirectId()&&b.setRedirectNumber(a.destinationnumber)}),callFunc(a,E(c.result,c,1103," getredirectrules"))})},saveUserRedirect:function(a,b){var c=this;return a?H("saveredirectrules",{redirectrule:{id:c.getUserRedirectId(),caption:"Переадресация сохраненная из веб-октела. Действует постоянно.",description:"Переадресация сохраненная из веб-октела. Действует постоянно.",priority:1,userid:k.userid,isenabled:!0,allowcascade:!0,state:2,destinationnumber:a,onlyforredirectstate:!0,definesources:!1}},function(d){d.result&&c.setRedirectNumber(a),callFunc(b,E(d.result,d,1103," saveredirectrules"))}):H("deleteredirectrules",{ids:[this.getUserRedirectId()]},function(a){a.result&&(c.setRedirectNumber(void 0),c.webState()==c.webStates.REDIRECT&&c.changeStates(c.webStates.READY)),callFunc(b,E(a.result,a,1103," deleteredirectrules"))}),!0},enableUserRedirectState:function(a){H("setuserstate",{onredirect:a?!0:!1})},setWebStateFromUserState:function(){if(this.onRedirect())this.webState(this.webStates.REDIRECT);else switch(this.state()){case 1:this.webState(this.webStates.READY);break;case 2:this.webState(this.webStates.BREAK);break;case 3:this.webState(this.webStates.DND);break;case 5:this.onBreak&&this.onCallCenter?this.webState(this.webStates.BREAK):this.webState(this.webStates.READY);break;case 7:this.webState(this.webStates.READY)}}});s("setRedirectNumber",V.saveUserRedirect,V),s("getStatus",V.getWebStateStr,V),s("setStatus",V.changeStates,V),s("setUserStateBusy",V.setUserStateBusy,V);var W={_conferenceInfo:{},_holdNumber:!1,_conferenceId:!1,abonentList:{},queueList:{},answerCheckTimeout:3e3,_talkLength:0,_talkTimer:!1,sip:!1,sipActive:!1,sipHasRTCSession:!1,_notRoutingIvrState:!1,currentSessionData:{},intercomSupport:null,states:{DISCONNECTED:-1,READY:0,BACKCALL:1,CALL:2,RING:3,BACKRING:4,TALK:5},setSipphone:function(a){var b=this;b.sip=a,b.sip.on("connect",function(){b.sipActive=!0}),b.sip.on("disconnect",function(){b.sipHasRTCSession=!1,b.sipActive=!1}),b.sip.on("ringStart",function(a,b){f.trigger("webrtcRingStart",a,b)}),b.sip.on("RTCSessionFailed",function(){}),b.sip.on("RTCSessionStarted",function(){b.sipHasRTCSession=!0,f.trigger("")}),b.sip.on("RTCSessionEnded",function(){b.sipHasRTCSession=!1,b.loadStates()}),b.sip.on("sessionClose",function(){b.sipHasRTCSession=!1,b.loadStates()})},notRoutingIvrState:function(a){return"undefined"!=typeof a&&Boolean(a)!==this._notRoutingIvrState&&(this._notRoutingIvrState=Boolean(a)),this._notRoutingIvrState},answer:function(a){var b,c,d,e=this;e.sipActive?(e.sip.answer(),callFunc(a,D())):e.intercomSupport===!1?callFunc(a,C(2902)):e.state()==e.states.RING||e.state()==e.states.BACKRING?(H("pbxanswercall"),d=function(){clearInterval(b),clearTimeout(checkTimer),callFunc(a,E(e.intercomSupport,{},2902))},c=function(){return e.intercomSupport=e.state()==e.states.TALK||e.state()==e.states.CALL},b=setInterval(function(){c()&&d()},50),checkTimer=setTimeout(function(){d()},e.answerCheckTimeout)):callFunc(a,C(2901))},setConferenceInfo:function(a){this._conferenceInfo="object"==typeof a?a:{}},getConferenceInfo:function(){return this._conferenceInfo||{}},clearHold:function(){return this.setHold(!1),!0},setHold:function(a){var b=this.getHoldInfo();if(void 0!==a&&(a.userid&&a.userid!=this._holdNumber||a.number&&a.number!=this._holdNumber||a.conferenceid&&a.conferenceid!=this._holdNumber)){var c=this._holdAbonent;this._holdNumber=a.conferenceid?a.conferenceid:a.userid?a.userid:a.number,this._holdAbonent=a.conferenceid?{isConference:!0,conferenceId:a.conferenceid,conferenceName:a.conferencename,conferenceRoom:a.conferenceroom}:this.createAbonent(a);var d=!1;(c&&c.key!=this._holdAbonent.key||!this._holdAbonent)&&(d=!0,f.trigger("holdAbonentLeave",cloneObject(c))),c&&this._holdAbonent&&this._holdAbonent.key&&c.key&&this._holdAbonent.key==c.key||(d=!0,f.trigger("holdAbonentEnter",cloneObject(this._holdAbonent)));var e=this.getHoldInfo();return(b.hasHold!=e.hasHold||d)&&f.trigger("holdStateChange",cloneObject(e)),!0}if(a===!1){this._holdAbonent&&f.trigger("holdAbonentLeave",cloneObject(this._holdAbonent)),this._holdAbonent=void 0;var g=this._holdNumber;this._holdNumber=!1,g!==this._holdNumber&&f.trigger("holdStateChange",cloneObject(this.getHoldInfo()))}return!1},getHoldInfo:function(){var a={hasHold:this._holdNumber?!0:!1};return a.hasHold&&(this._holdAbonent&&this._holdAbonent.isConference?extend(a,cloneObject(this._holdAbonent)):(a.isConference=!1,a.abonent=cloneObject(this._holdAbonent))),a},conferenceId:function(a,b){if(void 0!==a&&a!=this._conferenceId){var c=this._conferenceId;this._conferenceId=a,c&&H("confhandleevent",{conferenceid:c,eventtype:"competitors",handle:!1}),this._conferenceId?(H("confhandleevent",{conferenceid:this._conferenceId,eventtype:"competitors",handle:!0}),b||this.loadConferenceInfo()):this.setConferenceInfo(!1)}return this._conferenceId},isConfCreator:function(a){return void 0!==a&&(this._isConfCreator=a?!0:!1),this._isConfCreator},getStateStr:function(a){return w(void 0===a?this._stateId:parseInt(a),this.states)},apiGetStateStr:function(a){var b=void 0===a?this.state():parseInt(a);return b==this.states.BACKCALL&&(b=this.states.CALL),this.getStateStr(b)},state:function(a,b,c){if(a=parseInt(a),this.getStateStr(a)&&(c||a!=this._stateId)){var d=this.apiGetStateStr(a),e=this._stateId,g=this.apiGetStateStr(e);log("CHANGE STATE FROM "+this.getStateStr(this._stateId)+" TO "+this.getStateStr(a),this.getAbonents(!0),b),this._stateId=a,(a===this.states.READY||a===this.states.DISCONNECTED)&&(this.removeAbonents(),this.conferenceId(!1),this.isConfCreator(!1),a===this.states.DISCONNECTED&&this.clearHold()),f.trigger("stateChange",d,g);var h=this.getAbonents(!0);switch(0==h.length&&(h=b),e){case this.states.READY:f.trigger("readyStop",b);break;case this.states.RING:f.trigger("ringStop",b);break;case this.states.BACKRING:f.trigger("backRingStop",b);break;case this.states.CALL:f.trigger("callStop",b);break;case this.states.BACKCALL:f.trigger("callStop",b);break;case this.states.TALK:f.trigger("talkStop",b)}switch(this._stateId){case this.states.READY:f.trigger("readyStart",h);break;case this.states.RING:f.trigger("ringStart",h);break;case this.states.BACKRING:f.trigger("backRingStart",h);break;case this.states.CALL:f.trigger("callStart",h);break;case this.states.BACKCALL:f.trigger("callStart",h);break;case this.states.TALK:f.trigger("talkStart",h)}}return this._stateId},loadFlashInfo:function(a){var b=this;H("getflashedabonentinfo",{},function(c){c.result&&(c.containsflashed&&c.abonent?b.setHold(c.abonent):b.clearHold()),callFunc(a,E(c.result,c,1103," getflashedabonentinfo"))})},loadStates:function(a,b){var c=this;return b=b||{},extend(c.currentSessionData,b),v()?(H("getextendedlineinfo",{},function(b){var d=function(){callFunc(a,E(b.result,b,1103," getextendedlineinfo"))};if(log("getextendedlineinfo result and that.currentSessionData",b,c.currentSessionData),b.result){var e=c.state();c.getHoldInfo();var f=c.getAbonents(!0);f&&f[0]||!1;var g=function(){log("setStateFromResultData"),c.getHoldInfo();var a=c.getAbonents(!0);if(a&&a[0]||!1,c.currentSessionData.isAutoCall&&!b.abonent.isautocall&&e==c.states.READY)c.state(c.states.BACKRING,f);else if(b.abonent.isautocall)c.currentSessionData.isAutoCall=!1,c.state(c.states.BACKCALL,f);else if(b.abonent.isringing)"acm_callback"==b.abonent.direction||e==c.states.BACKRING?c.state(c.states.BACKRING,f):c.state(c.states.RING,f);else if(!c.currentSessionData.isAutoCall&&(b.abonent.iscommutated||b.abonent.iswaitinginflash||b.abonent.isconference)||"lsCommutated"==b.linestatestr&&b.abonent.isivr&&!b.abonent.isroutingivr){c.startTalkTimer(parseInt(b.timertalklensec)||0);var d=c.currentSessionData.commStopped;c.currentSessionData.commStopped=!1,c.state(c.states.TALK,f,d)}else b.abonent.extline||b.abonent.number?(c.currentSessionData.isAutoCall=!1,c.state(c.states.CALL,f)):"lsDisconnected"==b.linestatestr?c.state(c.states.DISCONNECTED):e==c.states.TALK&&c.sipHasRTCSession||"lsReserved"!=b.linestatestr&&(c.currentSessionData={},c.state(c.states.READY,f))};b.isflashing&&b.flashed?c.setHold(b.flashed):c.setHold(!1),b.abonent?b.abonent.conferenceid?(c.conferenceId(b.abonent.conferenceid,!0),c.loadConferenceInfo(function(){g(),d()})):(b.abonent.chainId=b.chainid,c.setAbonent(b.abonent,e==c.states.TALK&&c.sipHasRTCSession||b.abonent.isivr||c.currentSessionData.isAutoCall),c.conferenceId(!1),g(),d()):d()}else d()}),void 0):!1},loadConferenceInfo:function(a){var b=this;H("getconferenceinfo",{conferenceid:this.conferenceId()},function(c){b.setConfAbonentList(c.competitors),b.setConferenceInfo(c.conference),callFunc(a,E(c.result,c,1103," getconferencecompetitors"))})},createAbonent:function(a){var b=a.competitorid||a.number||a.userid||a.callerid||"00000000-0000-0000-0000-000000000000"!=a.chainId&&a.chainId;if(!b&&a.isivr&&(b=newGuid()),b){var c=new Abonent;return extend(c,{key:b,guid:a.competitorid||a.userid,isIvr:a.isivr,ivrName:a.ivrname||void 0,isConferenceCompetitor:a.competitorid?!0:!1,conferenceId:this.conferenceId(),isConferenceCreator:a.competitorid&&a.iscreator?!0:void 0,isConferenceDirector:a.competitorid&&a.isdirector?!0:void 0,isConferenceGhost:a.competitorid&&a.isghost?!0:void 0,isConferenceGhostMajor:a.competitorid&&a.isghostmajor?!0:void 0,isConferenceHidden:a.competitorid&&a.ishidden?!0:void 0,isExternal:a.isextline?!0:!1,chainId:a.chainId,phone:a.number?a.number.toString():a.calledid?a.callerid.toString():void 0,phoneFormatted:a.number?formatPhone(a.number.toString()):void 0,name:a.simplename||a.username||a.name||a.caption||a.userlogin||a.number||a.ivrname,isUser:a.userid?!0:!1,user:{id:a.userid||void 0,name:a.username||void 0,login:a.userlogin||void 0,comment:a.comment||void 0},isClient:void 0,client:{id:void 0,name:void 0},line:{id:void 0,number:void 0}}),c}return!1},setAbonent:function(a,b){var c;size(this.abonentList)&&each(this.abonentList,function(a,b){c=b});var d=this.abonentList[c];this.abonentList={};var e=a?this.createAbonent(a):void 0;return e?(this.abonentList[e.key]=e,e.key!=c&&(f.trigger("abonentListChange",this.getAbonents()),f.trigger("abonentsChange",this.getAbonents(!0)))):d&&b?this.abonentList[c]=d:c&&(f.trigger("abonentListChange",this.getAbonents()),f.trigger("abonentsChange",this.getAbonents(!0))),this.abonentList},setConfAbonentList:function(a){var b={},c=this;a&&isArray(a)&&each(a,function(a){if((!c.getConferenceInfo().isghost||c.getConferenceInfo().isghost&&(a.isghost||a.userid==k.userid||a.number==k.number))&&(b[a.competitorid]=!0,!c.abonentList[a.competitorid])){var d=c.createAbonent(a);c.abonentList[d.key]=d,c.conferenceId()&&c.state()==c.states.TALK&&f.trigger("conferenceAbonentEnter",c.abonentList[d.key])}});var d=c.getAbonents();return each(d,function(a,d){b[d]||c.removeAbonents(d)}),f.trigger("abonentListChange",c.getAbonents()),f.trigger("abonentsChange",c.getAbonents(!0)),!0},getAbonents:function(a){var b=a?[]:{};return each(this.abonentList,function(c,d){a?b.push(cloneObject(c)):b[d]=cloneObject(c)}),b},isAbonent:function(a,b){if(!a)return!1;if(b=b||this.getAbonents(),size(b)){b.key&&(b=[b]);var c=!1;return each(b,function(b){return b.guid&&b.guid==a||b.user&&b.user.id&&b.user.id==a||b.client&&b.client.id&&b.client.id==a||b.phone&&b.phone==a?(c=cloneObject(b),breaker):void 0}),c}return!1},removeConfAbonents:function(){var a=this;each(a.abonentList,function(b,c){a.conferenceId()&&a.state()==a.states.TALK&&b.isConferenceCompetitor&&f.trigger("conferenceAbonentLeave",b),delete a.abonentList[c]})},removeAbonents:function(a){var b=this;if(a&&b.abonentList[a])b.conferenceId()&&b.state()==b.states.TALK&&b.abonentList[a].isConferenceCompetitor&&f.trigger("conferenceAbonentLeave",b.abonentList[a]),delete b.abonentList[a],f.trigger("abonentListChange",b.getAbonents()),f.trigger("abonentsChange",b.getAbonents(!0));else{if(void 0!==a||!size(b.abonentList))return!1;each(b.abonentList,function(a,c){b.conferenceId()&&b.state()==b.states.TALK&&a.isConferenceCompetitor&&f.trigger("conferenceAbonentLeave",a),delete b.abonentList[c]}),b.abonentList={}}return f.trigger("abonentListChange",b.getAbonents()),f.trigger("abonentsChange",b.getAbonents(!0)),!0},makeCall:function(a,b,c,d){var e,f=this,g="";if(a||(e=2106),V.state()==V.states.DISCONNECTED&&(e=2001),f.state()==f.states.DISCONNECTED&&(e=2002),f.getHoldInfo().hasHold&&f.state()==f.states.TALK&&(e=2101),f.conferenceId()&&(e=2102),-1!=[f.states.BACKCALL,f.states.BACKRING,f.states.CALL,f.states.RING].indexOf(f.state())&&(e=2103,g=" ("+f.getStateStr()+")"),f.state()!=f.states.READY||V.state()!=V.states.BUSY||f.getHoldInfo().hasHold||(e=2104),e)return callFunc(d,C(e)),!1;if(f.isAbonent(a))return callFunc(d,C(2105)),!1;if(f.state()==f.states.READY&&f.sipActive&&!b)f.state()==f.states.TALK&&f.sip.hold(),f.sip.call(a),o[a],p[a]||q[a],callFunc(d,D());else{if(f.state()!=f.states.READY&&f.state()!=f.states.TALK)return log("error call, unknown state"),callFunc(d,C(2108)),!1;f.acmCall(a,b,c,function(a){callFunc(d,E(a.result,a,2107))})}},acmCall:function(a,b,c,d){if(c=-1!==["abonent","user"].indexOf(c)?c:"user",!a)return!1;var e={sequence:b?"user":c,intercom:b?!0:void 0};e.number=a.toString(),H("pbxautocallstart",e,function(a){callFunc(d,a)})},toggleHold:function(a){var b=this;b.getHoldInfo().hasHold?(b.makeFlash("switch"),callFunc(a,D())):callFunc(a,C(2402))},makeFlash:function(a){var b=["abort","switch","next"];H("pbxmakeflash",{mode:-1!=b.indexOf(a)?a:void 0})},conference:function(a,b){var c=this;a=x(a),V.state()==V.states.BREAK?callFunc(b,C(2208)):c.state()==c.states.TALK?c.conferenceId()&&a?c.inviteToConf(c.conferenceId(),a,b):c.conferenceId()||(a?c.callToConf(function(d){d.result?c.inviteToConf(c.conferenceId(),a,b):callFunc(b,C(2202))}):c.callToConf(b)):c.state()==c.states.READY&&!c.conferenceId()&&a?c.createConf(a,b):callFunc(b,C(2205))},callToConf:function(a){var b=this;b.buildConfFromCommCallback=a,b.buildConfFromCommTimer=setTimeout(function(){callFunc(b.buildConfFromCommCallback,C(2202)),b.buildConfFromCommCallback=void 0},2e3),H("buildconferencefromcommutation")
},createConf:function(a,b){var c=this,d=newGuid(),e=Math.round(1e4*Math.random()),f=[{userlogin:k.login}];a=x(a),isArray(a)&&each(a,function(a){isGuid(a)?f.push({userid:a}):f.push({intnumber:a})}),size(f)>1?H("createnewconference",{conference:{id:d,room:e,name:"",description:"",accessmode:"free",isselector:!1,record:!0,recordrights:"selected",everyonecaninvite:!0,canvieweachother:!0},competitors:f},function(a){1==a.result?c.conferenceId(d,!0):c.conferenceId(!1),callFunc(b,E(a.result,a,2204))}):callFunc(b,C(2203))},inviteToConf:function(a,b,c){a||callFunc(c,!1);var d=this;b=x(b);var e,f=[],g=d.getHoldInfo().abonent||{};isArray(b)&&each(b,function(a){"string"==typeof a&&""!==a&&(d.isAbonent(a,g)?e=a:isGuid(a)?f.push({userid:a}):f.push({intnumber:a}))});var h=function(){H("invitetoconference",{conferenceid:a,competitors:f},function(a){callFunc(c,E(a.result,a,2202))})};if(0!=size(f)||e)if(e){if(a!=d.conferenceId())return callFunc(c,C(2206)),void 0;H("checkcanconnecttogathertoconference",{},function(a){a.canconnecttogather?(H("connecttogathertoconference"),0!=size(f)?h():callFunc(c,D())):callFunc(c,C(2206))})}else 0!=size(f)?h():callFunc(c,C(2207));else callFunc(c,C(2201))},endCall:function(a){var b=this;a=x(a);var c=!1,d=!1;a&&each(a,function(a){!c&&b.isAbonent(a)&&(c=!0),d||a!=k.number&&a!=k.userid||(d=!0)}),a?b.getHoldInfo().hasHold&&(d||!b.conferenceId()&&c)?b.makeFlash("abort"):(c||d)&&(b.state()==b.states.TALK?b.conferenceId()?b.kickConfAbonent(b.conferenceId(),a):b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():b.state()==b.states.CALL?b.abortCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()):b.state()==b.states.TALK||b.state()==b.states.CALL||b.getHoldInfo().hasHold?b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()},abortCall:function(){H("pbxabortcall")},declineCall:function(){H("pbxdeclinecall")},kickConfAbonent:function(a,b){b=x(b);var c=this;H("getconferencecompetitors",{conferenceid:a},function(d){for(var e={},f={},g=!1,h=0,i=d.competitorlist.length;i>h;h++)e[d.competitorlist[h].number]=d.competitorlist[h].competitorid,f[d.competitorlist[h].userid]=d.competitorlist[h].competitorid;var j;each(b,function(b){(j=e[b]||f[b]||"")&&(!b||b!=k.number&&b!=k.userid?H("confdisconnectcompetitor",{conferenceid:a,competitor:{competitorid:j}}):g=!0)}),g&&c.exitConf(a)})},abortAcmCall:function(){H("pbxautocallabort")},exitConf:function(a){H("exitconference",{conferenceid:a})},makeTransfer:function(a,b){H("pbxmaketransfer",{transferto:a?a+"":""}),callFunc(b,D())},transfer:function(a,b){var c=this;a||callFunc(b,C(2304)),c.state()==c.states.TALK?c.getHoldInfo().hasHold?!a||c.isAbonent(a,c.getHoldInfo().abonent||{})?(c.endCall(void 0),callFunc(b,D())):c.makeTransfer(a,b):a?c.makeTransfer(a,b):callFunc(b,C(2302)):callFunc(b,C(2303))},ghost:function(a,b,c){var d=this,e=function(a){d.loadConferenceInfo(callFunc(c,a))};if(a=o[a]&&o[a].id||p[a]&&p[a].userid,!a)return callFunc(e,C(2504)),!1;if(b=b||"monitor",-1==["monitor","conference","help"].indexOf(b))return callFunc(e,C(2503)),!1;if(d.state()==d.states.READY)H("attachasghost",{ghostedid:a},function(a){a.result?b&&"monitor"!=b?setTimeout(function(){d.conferenceId()&&d.changeGhostMode(b,e)},500):callFunc(e,D()):52710==a.error?callFunc(e,C(2505)):callFunc(e,C(2502))});else{var f=d.isAbonent(k.userid),g=d.conferenceId();if(!f||!g||!d.getConferenceInfo().isghost)return callFunc(e,C(2506)),!1;var h=d.isAbonent(a);if(!h)return callFunc(e,C(2507)),!1;h.isConferenceGhostMajor||"help"!=b&&"monitor"!=b?H("confsetghostmode",{conferenceid:g,ghostmode:b},function(a){a.result,callFunc(e,E(a.result,{},2502))}):H("confsetvoiceparams",{conferenceid:g,competitor:{competitorid:h.guid,ghosthelp:"help"==b?!0:!1}},function(a){a.result,callFunc(e,E(a.result,{},2502))})}},queue:function(a){var b=this;H("getcurrentqueue",{},function(c){if(c.result){var d={},e=[],g=!1;isArray(c.queue)&&size(c.queue)>0&&each(c.queue,function(a){ab=b.createAbonent(a),d[ab.key]=ab,e.push(ab),b.queueList[ab.key]||b.isAbonent(ab.key)||(b.queueList[ab.key]=ab,f.trigger("queueAbonentEnter",ab),g=!0)}),each(b.queueList,function(a,c){d[c]||(f.trigger("queueAbonentLeave",a),delete b.queueList[c],g=!0)}),g&&f.trigger("queueChange",e),callFunc(a,D({queue:e}))}else callFunc(a,C(2701))})},startTalkTimer:function(a){var b=this;b.clearTalkTimer(!0),b._talkLength=Date.now()-1e3*(parseInt(a)||0),b.triggerTalkTimeEvent(),b._talkTimer=setInterval(function(){b.triggerTalkTimeEvent()},1e3)},triggerTalkTimeEvent:function(){var a=this;if(a._talkLength!==!1){var b=a.getCurrentTalkLength();f.trigger("talkTimer",b,a.formatTime(b))}else f.trigger("talkTimer",!1)},getCurrentTalkLength:function(){return Math.floor((Date.now()-this._talkLength)/1e3)},clearTalkTimer:function(a){clearInterval(this._talkTimer),this._talkLength=!1,a||this.triggerTalkTimeEvent()},formatTime:function(a){var b=a,c=Math.floor(b/3600),d=Math.floor(b/60)%60,e=b%60;return(c?c+":":"")+(10>d?"0"+d:d)+":"+(10>e?"0"+e:e)},talkLength:function(a){if(this._talkLength===!1)return"";var b=this.getCurrentTalkLength();return a?this.formatTime(b):b},dtmf:function(a){return this.sipActive&&"string"==typeof a&&a.match(/^[0-9\*#]{1}$/)?this.sip.dtmf(a):!1},hold:function(){this.sipActive?this.sip.hold():(this.state()==this.states.TALK||this.getHoldInfo().hasHold)&&this.makeFlash("switch")},resume:function(){this.getHoldInfo().hasHold&&this.sipActive&&this.sip.resume()}};extend(W,Events),s("isAbonent",W.isAbonent,W),s("conferenceId",W.conferenceId,W),s("getHoldInfo",W.getHoldInfo,W),s("endCall",W.endCall,W),s("conference",W.conference,W),s("transfer",W.transfer,W),s("toggle",W.toggleHold,W),s("getState",W.apiGetStateStr,W),s("getQueue",W.queue,W),s("getTalkLength",W.talkLength,W),s("answer",W.answer,W),s("dtmf",W.dtmf,W),s("hold",W.hold,W),s("resume",W.resume,W);var X={};X["-"]={},X[W.states.DISCONNECTED]={},X[W.states.BACKCALL]={endCall:1},X[W.states.BACKRING]={endCall:1,answer:1},X[W.states.CALL]={endCall:1,conference:1,call:1,intercom:1,transfer:1},X[W.states.READY]={conference:1,call:1,intercom:1,ghostListen:1,ghostHelp:1,ghostConference:1,transfer:1,toggle:1,endCall:1,resume:1},X[W.states.RING]={endCall:1,answer:1},X[W.states.TALK]={endCall:1,conference:1,call:1,resume:1,hold:0,intercom:1,toggle:1,transfer:1,ghostListen:1,ghostHelp:1,ghostConference:1};var Y={};Y["-"]={},Y[V.states.DISCONNECTED]={},Y[V.states.READY]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1,resume:1},Y[V.states.BREAK]={endCall:1,call:1,intercom:1,toggle:1,transfer:1,ghostListen:1,resume:1,ghostHelp:1,ghostConference:1},Y[V.states.OFF]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1},Y[V.states.BUSY]={answer:1,endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,hold:0,ghostListen:1,ghostHelp:1,ghostConference:1},Y[V.states.RESERVED]={},Y[V.states.NOPHONE]={};var Z=function(){var a=[],b=W.state();b="number"==typeof b?b:"-";var c=V.state()||"-";c="number"==typeof c?c:"-",this.push=function(){each(arguments,function(d){X[b][d]&&Y[c][d]&&a.push(d)})},this.getActions=function(){return a}},$=function(a){var b=new Z;if(!a||!v())return b.getActions();o[a]&&o[a].number&&!p[a]&&!q[a]&&(a=o[a].number);var c=k.userid==a||k.number==a,d=W.isAbonent(a,W.getHoldInfo().abonent||{}),e=o[a]||p[a]||q[a];e&&e.numberObj&&(e=e.numberObj);var f=W.isAbonent(a)||e&&e.number&&W.isAbonent(e.number),g=W.isAbonent(a,W.queueList)||e&&e.number&&W.isAbonent(e.number,W.queueList),h=W.getHoldInfo().hasHold,i=W.conferenceId()?!0:!1;i&&f&&f.isConferenceCreator;var j=i&&W.isAbonent(k.userid),l=i&&j&&j.isConferenceCreator,m=W.state(),n=W.intercomSupport;return g||(c?m!=W.states.DISCONNECTED&&m!=W.states.READY&&(m!=W.states.RING&&m!=W.states.BACKRING||!W.sipActive&&n===!1||b.push("answer"),b.push("endCall")):(!e||e&&void 0!==e.state&&0!=e.state)&&(d?W.sipActive&&m==W.states.READY?b.push("resume"):b.push("toggle","endCall"):f?f&&(m!=W.states.RING&&m!=W.states.BACKRING||!W.sipActive&&n===!1||b.push("answer"),i?l&&b.push("endCall"):(b.push("endCall"),W.sipActive&&!h&&b.push("hold"),e&&2==e.state||b.push("conference")),W.getConferenceInfo().isghost&&L(a)&&b.push("ghostListen","ghostHelp","ghostConference")):(i?(e&&2==e.state||b.push("conference"),b.push("transfer")):!h&&m==W.states.TALK||m==W.states.READY?(b.push("call"),m==W.states.TALK&&b.push("transfer"),e&&2==e.state||b.push("conference"),b.push("intercom")):h&&m==W.states.TALK&&b.push("transfer"),e&&5==e.state&&m==W.states.READY&&L(a)&&b.push("ghostListen","ghostHelp","ghostConference")))),b.getActions()};s("getPhoneActions",$),startQueueTimer=function(a){clearInterval(c),c=setInterval(function(){v()&&W.queue()},a)};var _=function(c){if(f.trigger("connecting"),v())return!0;c=c||{};var g=!1;extend(i,c),debugMode=i.debugMode,d=!1,i.oktellVoice&&(i.oktellVoice.isOktellVoice===!0?d=i.oktellVoice:window.oktellVoice&&window.oktellVoice.isOktellVoice===!0&&(d=window.oktellVoice));var l=cookie(n)||localStorage&&localStorage[n];l||void 0===c.password||null===c.password?i.password=void 0:(i.password=md5(utf8DecodePass(c.password.toString().toLowerCase())),i.Password=md5(utf8DecodePass(c.password.toString())));var o=/^w[s]{1,2}:\/\/\S+$/,q=/:[0-9]{1,5}$/,s=function(a){if(o.test(a))return a;var b="https:"==location.protocol,c=b?":443":":80",d=b?"wss://":"ws://";return q.test(a)?d+a:d+a+c};if("string"==typeof i.url&&(i.url=[i.url]),!isArray(i.url))return callFunc(i.callback,C(1205)),f.trigger("connectError",C(1205)),!1;for(var w=[],x=0,z=i.url.length;z>x;x++)"string"==typeof i.url[x]&&w.push(s(i.url[x]));if(i.url=w,WEB_SOCKET_SWF_LOCATION=i.webSocketSwfLocation,window.flashWebSocketInitialized||(window.flashWebSocketInitialized=!0,initFlashWebSocket()),k.url=i.url,k.login=i.login,k.defaultAvatar=i.defaultAvatar,k.defaultAvatar32x32=i.defaultAvatar32x32,k.defaultAvatar64x64=i.defaultAvatar64x64,!l&&(void 0===i.password||null===i.password))return callFunc(i.callback,C(1213)),f.trigger("connectError",C(1213)),!1;var A=function(){a=new Server(i.url,i.openTimeout,i.queryDelayMin,i.queryDelayMax,function(c){g=!1,k.currentUrl=a.url,H("login",{Password:i.Password,password:i.password,sessionid:l||void 0,showid:1,usewebrtc:d?!0:!1,workplace:i.workplace||void 0,expires:i.expires||void 0},function(l){g=!0;var o=function(){return C(q,"",{serverErrorMessage:l.errormsg,serverErrorCode:l.error})};if(l.error||l.errormsg){var q=1e3;50093==l.error?q=1204:50025==l.error?q=1214:"Wrong login/pass combination"==l.errormsg?(cookie(n,null),localStorage&&delete localStorage[n],q=1202):("Bad request. Session does not exist"==l.errormsg||"Bad request. Invalid session user"==l.errormsg)&&(cookie(n,null),localStorage&&delete localStorage[n],q=1212),callFunc(i.callback,o(q)),f.trigger("connectError",o(q)),bb(14)}else 1==l.result?(clearInterval(b),b=setInterval(function(){v()&&a.sendOktell("ping")},15e3),startQueueTimer(i.queueInterval),W.queue(),J.sendCustomBinding(),a.bindOktellEvent("userstatechanged",function(a){V.saveStatesFromServer(a)}),d&&setTimeout(function(){e=d.connect({login:l.sipuser,password:l.sippass,server:c.replace(/w[s]{1,2}:\/\//,"").replace("/","").split(":")[0]+":"+l.sipport,debugMode:debugMode}),e&&(e.on("connect",function(){j=!0,f.trigger("webphoneConnect")}),e.on("all",function(a){log("Oktell webphone event: "+a,arguments)}),e.on("disconnect",function(){j=!0,f.trigger("webphoneDisconnect")}),W.setSipphone(e))},200),k.userid=l.userid,k.sessionId=l.sessionid,k.sessionId&&(cookie(n,k.sessionId,{expires:i.expires}),localStorage&&(localStorage[n]=k.sessionId)),H("getversion",{showalloweddbstoredprocs:1},function(b){b.result?(k.oktellBuild=b.version.build,k.oktellDated=b.version.dated,k.allowedProcedures=b.alloweddbstoredprocs||{},k.oktellWebServerPort=b.version.webserverport,k.oktellWebServerLink=N(),y("pbxanswercall")||(W.intercomSupport=!1),H("getmyuserinfo",{},function(b){b.result?(k.number=b.mainpbxnumber,k.username=b.username,k.hasline=b.hasline,k.lineid=b.lineid,k.linenumber=b.linenumber,k.isoperator=b.isoperator,V.loadBreakReasons(function(){V.loadState(function(b){b?V.checkUserRedirect(function(){M(function(){a.bindOktellEvent("pbxnumberstatechanged",function(a){for(var b=0;b<a.numbers.length;b++){var c=p[a.numbers[b].num];c&&(c.state=a.numbers[b].numstateid)}}),K(function(){W.loadStates(function(b){if(b){g=!1,u.trigger("login"),a.bindOktellEvent("httpresponsecopy",function(a){var b=a.response;if("200 OK"==b){var c=a.password,d=a.content;m[c]&&"function"==typeof m[c].callback&&m[c].callback(d)}}),callFunc(i.callback,D()),t(!0);for(var c=0;c<h.length;c++){var d=h[c];d&&d.eventName&&d.callback&&!d.binded&&(d.binded=!0,a.bindOktellEvent(d.eventName,d.callback))}f.trigger("connect")}else callFunc(i.callback,o(1207)),f.trigger("connectError",o(1207)),bb(14)})})})}):(callFunc(i.callback,o(1209)),f.trigger("connectError",o(1209)),bb(14))})})):(callFunc(i.callback,o(1210)),f.trigger("connectError",o(1210)),bb(14))})):(callFunc(i.callback,o(1206)),f.trigger("connectError",o(1206)),bb(11))})):(callFunc(i.callback,o(1211)),f.trigger("connectError",o(1211)),bb(14))})}),a.on("errorConnection",function(){f.trigger("connectError",C(1200)),callFunc(i.callback,C(1200))}),a.on("connectionClose",function(){r?(r=!1,bb(13)):g||bb(12)}),a.multiConnect(),debugMode&&(k.server=a)};A()};s("connect",_);var bb=function(a,b){t(!1);for(var c=0;c<h.length;c++){var d=h[c];d.binded=!1}return e&&e.disconnect&&e.disconnect(),v()?(cookie(n,null),localStorage&&delete localStorage[n],r=!0,V.state(0),W.state(W.states.DISCONNECTED),H("logout")):("number"==typeof a&&(a=A(a)),b||f.trigger("disconnect",a)),!0},cb=function(){return cookie(n,null),!0};s("removeUserSession",cb),V.on("userStateChange",function(a){setTimeout(function(){W.loadStates()},400),5==a||(7==a?W.state(W.states.DISCONNECTED):W.loadStates())}),u.on("login",function(){a.bindOktellEvent("linestatechanged",function(){setTimeout(function(){W.loadStates()},500)}),a.bindOktellEvent("flashstatechanged",function(){setTimeout(function(){W.loadStates()},500)}),a.bindOktellEvent("confcompositionchanged",function(a){a.eventinfo.conferenceid==W.conferenceId()&&(W.setConfAbonentList(a.eventinfo.competitorlist),W.loadStates())}),a.bindOktellEvent("phoneevent_acmcallstarted",function(){W.loadStates(null,{isAutoCall:!0})}),a.bindOktellEvent("phoneevent_acmcallstopped",function(){setTimeout(function(){W.loadStates()},700)}),a.bindOktellEvent("phoneevent_ringstarted",function(){W.loadStates(function(){W.conferenceId()&&W.loadConferenceInfo()},!1)}),a.bindOktellEvent("phoneevent_ringstopped",function(){W.loadStates()}),a.bindOktellEvent("phoneevent_ivrstarted",function(a){a.isroutingivr===!1?W.notRoutingIvrState(!0):a.isroutingivr===!0&&W.state()==W.states.READY&&W.loadStates()}),a.bindOktellEvent("phoneevent_commstarted",function(a){W.startTalkTimer(0),W.currentSessionData.commStarted=!0,a.isconference?(W.buildConfFromCommCallback&&(W.isConfCreator(!0),clearTimeout(W.buildConfFromCommTimer)),W.conferenceId(a.confid),W.loadConferenceInfo(function(){W.loadStates(function(){W.buildConfFromCommCallback&&(callFunc(W.buildConfFromCommCallback,D()),W.buildConfFromCommCallback=void 0)})})):setTimeout(function(){W.loadStates(function(){})},700)}),a.bindOktellEvent("phoneevent_commstopped",function(){W.clearTalkTimer(),W.currentSessionData.commStopped=!0,setTimeout(function(){W.loadStates(function(){})},700)}),V.loadBreakReasons()}),f.disconnect=function(a){return bb(13,a)},f.getAbonents=function(){return W.getAbonents(!0)},f.call=function(a,b,c){W.makeCall(a,!1,"string"==typeof b?b:"","function"==typeof b?b:c)},f.onNativeEvent=function(a,b){F(a,b)},f.offNativeEvent=function(a,b){G(a,b)},f.getMyInfo=function(){return cloneObject(k)},f.intercom=function(a,b){W.makeCall(a,!0,"",b)},f.ghostListen=function(a,b){W.ghost(a,"monitor",b)},f.ghostHelp=function(a,b){W.ghost(a,"help",b)},f.ghostConference=function(a,b){W.ghost(a,"conference",b)},f.getUsers=function(){var a={};return each(o,function(b){a[b.id]=b}),a},f.getNumbers=function(){var a={};return each(p,function(b){a[b.number]=b}),a},f.getLunchReasons=f.getBreakReasons=function(){return cloneObject(V.breakReasons)||{}},f.getLog=function(){return logStr},s("formatPhone",formatPhone,void 0),f.inCallCenter=function(){return V.callCenterState()},f.webphoneIsActive=function(){return j},f.changePassword=function(a,b,c){"string"==typeof a&&a?(a=md5(utf8DecodePass(a)),b=md5(utf8DecodePass(b)),f.exec("changepassword",{newpwdmd5:a,oldpwdmd5:b},function(a){a.result?callFunc(c,D({result:!0})):"old password is wrong"==a.errormsg?callFunc(c,C(2801)):callFunc(c,C(2803))})):callFunc(c,C(2802))},f.config=function(b){return b?(void 0!==b.debugMode&&(debugMode=Boolean(b.debugMode)),void 0!==b.queryDelayMin&&(a?a.setQueryDelayMin(b.queryDelayMin):i.queryDelayMin=b.queryDelayMin),void 0!==b.queryDelayMax&&(a?a.setQueryDelayMax(b.queryDelayMax):i.queryDelayMax=b.queryDelayMax),void 0!==b.queueInterval&&parseInt(b.queueInterval)&&startQueueTimer(parseInt(b.queueInterval)),void 0!==b.queryTimeout&&parseInt(b.queryTimeout)&&(i.queryTimeout=parseInt(b.queryTimeout)),void 0):!1},f.version="1.7.1"};return extend(Oktell.prototype,Events),Oktell}(),window.oktell=new Oktell;